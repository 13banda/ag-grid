/**
          * @ag-grid-community/infinite-row-model - Advanced Data Grid / Data Table supporting Javascript / Typescript / React / Angular / Vue * @version v30.0.0
          * @link https://www.ag-grid.com/
          * @license MIT
          */
/**
          * @ag-grid-community/infinite-row-model - Advanced Data Grid / Data Table supporting Javascript / Typescript / React / Angular / Vue * @version v30.0.0
          * @link https://www.ag-grid.com/
          * @license MIT
          */
import{Autowired as e,PostConstruct as t,PreDestroy as o,RowNodeBlock as s,_ as i,RowNode as r,Qualifier as n,BeanStub as a,NumberSequence as h,Events as c,Bean as d,ModuleNames as l}from"@ag-grid-community/core";var u=function(e,t,o,s){var i,r=arguments.length,n=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,o):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,o,s);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(n=(r<3?i(n):r>3?i(t,o,n):i(t,o))||n);return r>3&&n&&Object.defineProperty(t,o,n),n};class w extends s{constructor(e,t,o){super(e),this.parentCache=t,this.params=o,this.startRow=e*o.blockSize,this.endRow=this.startRow+o.blockSize}postConstruct(){this.createRowNodes()}getBlockStateJson(){return{id:""+this.getId(),state:{blockNumber:this.getId(),startRow:this.getStartRow(),endRow:this.getEndRow(),pageStatus:this.getState()}}}setDataAndId(e,t,o){!e.id&&e.alreadyRendered&&(e.alreadyRendered=!1),i.exists(t)?e.setDataAndId(t,o.toString()):e.setDataAndId(void 0,void 0)}loadFromDatasource(){const e=this.createLoadParams();i.missing(this.params.datasource.getRows)?console.warn("AG Grid: datasource is missing getRows method"):window.setTimeout(()=>{this.params.datasource.getRows(e)},0)}processServerFail(){}createLoadParams(){return{startRow:this.getStartRow(),endRow:this.getEndRow(),successCallback:this.pageLoaded.bind(this,this.getVersion()),failCallback:this.pageLoadFailed.bind(this,this.getVersion()),sortModel:this.params.sortModel,filterModel:this.params.filterModel,context:this.gridOptionsService.context}}forEachNode(e,t,o){this.rowNodes.forEach((s,i)=>{this.startRow+i<o&&e(s,t.next())})}getLastAccessed(){return this.lastAccessed}getRow(e,t=!1){t||(this.lastAccessed=this.params.lastAccessedSequence.next());const o=e-this.startRow;return this.rowNodes[o]}getStartRow(){return this.startRow}getEndRow(){return this.endRow}createRowNodes(){this.rowNodes=[];for(let e=0;e<this.params.blockSize;e++){const t=this.startRow+e,o=new r(this.beans);o.setRowHeight(this.params.rowHeight),o.uiLevel=0,o.setRowIndex(t),o.setRowTop(this.params.rowHeight*t),this.rowNodes.push(o)}}processServerResult(e){this.rowNodes.forEach((t,o)=>{const s=e.rowData?e.rowData[o]:void 0;this.setDataAndId(t,s,this.startRow+o)});const t=null!=e.rowCount&&e.rowCount>=0?e.rowCount:void 0;this.parentCache.pageLoaded(this,t)}destroyRowNodes(){this.rowNodes.forEach(e=>{e.clearRowTopAndRowIndex()})}}u([e("beans")],w.prototype,"beans",void 0),u([t],w.prototype,"postConstruct",null),u([o],w.prototype,"destroyRowNodes",null);var g=function(e,t,o,s){var i,r=arguments.length,n=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,o):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,o,s);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(n=(r<3?i(n):r>3?i(t,o,n):i(t,o))||n);return r>3&&n&&Object.defineProperty(t,o,n),n},p=function(e,t){return function(o,s){t(o,s,e)}};class f extends a{constructor(e){super(),this.lastRowIndexKnown=!1,this.blocks={},this.blockCount=0,this.rowCount=e.initialRowCount,this.params=e}setBeans(e){this.logger=e.create("InfiniteCache")}getRow(e,t=!1){const o=Math.floor(e/this.params.blockSize);let s=this.blocks[o];if(!s){if(t)return;s=this.createBlock(o)}return s.getRow(e)}createBlock(e){const t=this.createBean(new w(e,this,this.params));return this.blocks[t.getId()]=t,this.blockCount++,this.purgeBlocksIfNeeded(t),this.params.rowNodeBlockLoader.addBlock(t),t}refreshCache(){0==this.blockCount?this.purgeCache():(this.getBlocksInOrder().forEach(e=>e.setStateWaitingToLoad()),this.params.rowNodeBlockLoader.checkBlockToLoad())}destroyAllBlocks(){this.getBlocksInOrder().forEach(e=>this.destroyBlock(e))}getRowCount(){return this.rowCount}isLastRowIndexKnown(){return this.lastRowIndexKnown}pageLoaded(e,t){this.isAlive()&&(this.logger.log(`onPageLoaded: page = ${e.getId()}, lastRow = ${t}`),this.checkRowCount(e,t),this.onCacheUpdated())}purgeBlocksIfNeeded(e){const t=this.getBlocksInOrder().filter(t=>t!=e);t.sort((e,t)=>t.getLastAccessed()-e.getLastAccessed());const o=this.params.maxBlocksInCache>0,s=o?this.params.maxBlocksInCache-1:null,i=f.MAX_EMPTY_BLOCKS_TO_KEEP-1;t.forEach((e,t)=>{if(e.getState()===w.STATE_WAITING_TO_LOAD&&t>=i||!!o&&t>=s){if(this.isBlockCurrentlyDisplayed(e))return;if(this.isBlockFocused(e))return;this.removeBlockFromCache(e)}})}isBlockFocused(e){const t=this.focusService.getFocusCellToUseAfterRefresh();if(!t)return!1;if(null!=t.rowPinned)return!1;const o=e.getStartRow(),s=e.getEndRow();return t.rowIndex>=o&&t.rowIndex<s}isBlockCurrentlyDisplayed(e){const t=e.getStartRow(),o=e.getEndRow()-1;return this.rowRenderer.isRangeInRenderedViewport(t,o)}removeBlockFromCache(e){e&&this.destroyBlock(e)}checkRowCount(e,t){if("number"==typeof t&&t>=0)this.rowCount=t,this.lastRowIndexKnown=!0;else if(!this.lastRowIndexKnown){const t=(e.getId()+1)*this.params.blockSize+this.params.overflowSize;this.rowCount<t&&(this.rowCount=t)}}setRowCount(e,t){this.rowCount=e,i.exists(t)&&(this.lastRowIndexKnown=t),this.lastRowIndexKnown||this.rowCount%this.params.blockSize==0&&this.rowCount++,this.onCacheUpdated()}forEachNodeDeep(e){const t=new h;this.getBlocksInOrder().forEach(o=>o.forEachNode(e,t,this.rowCount))}getBlocksInOrder(){return i.getAllValuesInObject(this.blocks).sort((e,t)=>e.getId()-t.getId())}destroyBlock(e){delete this.blocks[e.getId()],this.destroyBean(e),this.blockCount--,this.params.rowNodeBlockLoader.removeBlock(e)}onCacheUpdated(){if(this.isAlive()){this.destroyAllBlocksPastVirtualRowCount();const e={type:c.EVENT_STORE_UPDATED};this.eventService.dispatchEvent(e)}}destroyAllBlocksPastVirtualRowCount(){const e=[];this.getBlocksInOrder().forEach(t=>{t.getId()*this.params.blockSize>=this.rowCount&&e.push(t)}),e.length>0&&e.forEach(e=>this.destroyBlock(e))}purgeCache(){this.getBlocksInOrder().forEach(e=>this.removeBlockFromCache(e)),this.lastRowIndexKnown=!1,0===this.rowCount&&(this.rowCount=this.params.initialRowCount),this.onCacheUpdated()}getRowNodesInRange(e,t){const o=[];let s=-1,r=!1;const n=new h;i.missing(e)&&(r=!0);let a=!1;this.getBlocksInOrder().forEach(i=>{a||(r&&s+1!==i.getId()?a=!0:(s=i.getId(),i.forEachNode(s=>{const i=s===e||s===t;(r||i)&&o.push(s),i&&(r=!r)},n,this.rowCount)))});return a||r?[]:o}}f.MAX_EMPTY_BLOCKS_TO_KEEP=2,g([e("rowRenderer")],f.prototype,"rowRenderer",void 0),g([e("focusService")],f.prototype,"focusService",void 0),g([p(0,n("loggerFactory"))],f.prototype,"setBeans",null),g([o],f.prototype,"destroyAllBlocks",null);var R=function(e,t,o,s){var i,r=arguments.length,n=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,o):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,o,s);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(n=(r<3?i(n):r>3?i(t,o,n):i(t,o))||n);return r>3&&n&&Object.defineProperty(t,o,n),n};let C=class extends a{getRowBounds(e){return{rowHeight:this.rowHeight,rowTop:this.rowHeight*e}}ensureRowHeightsValid(e,t,o,s){return!1}init(){this.gridOptionsService.isRowModelType("infinite")&&(this.rowHeight=this.gridOptionsService.getRowHeightAsNumber(),this.addEventListeners(),this.addDestroyFunc(()=>this.destroyCache()),this.verifyProps())}verifyProps(){if(this.gridOptionsService.exists("initialGroupOrderComparator")){const e="AG Grid: initialGroupOrderComparator cannot be used with Infinite Row Model. If using Infinite Row Model, then sorting is done on the server side, nothing to do with the client.";i.doOnce(()=>console.warn(e),"IRM.InitialGroupOrderComparator")}}start(){this.setDatasource(this.gridOptionsService.get("datasource"))}destroyDatasource(){this.datasource&&(this.getContext().destroyBean(this.datasource),this.rowRenderer.datasourceChanged(),this.datasource=null)}addEventListeners(){this.addManagedListener(this.eventService,c.EVENT_FILTER_CHANGED,this.onFilterChanged.bind(this)),this.addManagedListener(this.eventService,c.EVENT_SORT_CHANGED,this.onSortChanged.bind(this)),this.addManagedListener(this.eventService,c.EVENT_NEW_COLUMNS_LOADED,this.onColumnEverything.bind(this)),this.addManagedListener(this.eventService,c.EVENT_STORE_UPDATED,this.onCacheUpdated.bind(this))}onFilterChanged(){this.reset()}onSortChanged(){this.reset()}onColumnEverything(){let e;e=!this.cacheParams||this.isSortModelDifferent(),e&&this.reset()}isSortModelDifferent(){return!i.jsonEquals(this.cacheParams.sortModel,this.sortController.getSortModel())}getType(){return"infinite"}setDatasource(e){this.destroyDatasource(),this.datasource=e,e&&this.reset()}isEmpty(){return!this.infiniteCache}isRowsToRender(){return!!this.infiniteCache}getNodesInRangeForSelection(e,t){return this.infiniteCache?this.infiniteCache.getRowNodesInRange(e,t):[]}reset(){if(!this.datasource)return;null!=this.gridOptionsService.getCallback("getRowId")||this.selectionService.reset(),this.resetCache();const e=this.createModelUpdatedEvent();this.eventService.dispatchEvent(e)}createModelUpdatedEvent(){return{type:c.EVENT_MODEL_UPDATED,newPage:!1,newData:!1,keepRenderedRows:!0,animate:!1}}resetCache(){this.destroyCache(),this.cacheParams={datasource:this.datasource,filterModel:this.filterManager.getFilterModel(),sortModel:this.sortController.getSortModel(),rowNodeBlockLoader:this.rowNodeBlockLoader,initialRowCount:this.defaultIfInvalid(this.gridOptionsService.getNum("infiniteInitialRowCount"),1),maxBlocksInCache:this.gridOptionsService.getNum("maxBlocksInCache"),rowHeight:this.gridOptionsService.getRowHeightAsNumber(),overflowSize:this.defaultIfInvalid(this.gridOptionsService.getNum("cacheOverflowSize"),1),blockSize:this.defaultIfInvalid(this.gridOptionsService.getNum("cacheBlockSize"),100),lastAccessedSequence:new h},this.infiniteCache=this.createBean(new f(this.cacheParams))}defaultIfInvalid(e,t){return e>0?e:t}destroyCache(){this.infiniteCache&&(this.infiniteCache=this.destroyBean(this.infiniteCache))}onCacheUpdated(){const e=this.createModelUpdatedEvent();this.eventService.dispatchEvent(e)}getRow(e){if(this.infiniteCache&&!(e>=this.infiniteCache.getRowCount()))return this.infiniteCache.getRow(e)}getRowNode(e){let t;return this.forEachNode(o=>{o.id===e&&(t=o)}),t}forEachNode(e){this.infiniteCache&&this.infiniteCache.forEachNodeDeep(e)}getTopLevelRowCount(){return this.getRowCount()}getTopLevelRowDisplayedIndex(e){return e}getRowIndexAtPixel(e){if(0!==this.rowHeight){const t=Math.floor(e/this.rowHeight),o=this.getRowCount()-1;return t>o?o:t}return 0}getRowCount(){return this.infiniteCache?this.infiniteCache.getRowCount():0}isRowPresent(e){return!!this.getRowNode(e.id)}refreshCache(){this.infiniteCache&&this.infiniteCache.refreshCache()}purgeCache(){this.infiniteCache&&this.infiniteCache.purgeCache()}isLastRowIndexKnown(){return!!this.infiniteCache&&this.infiniteCache.isLastRowIndexKnown()}setRowCount(e,t){this.infiniteCache&&this.infiniteCache.setRowCount(e,t)}};R([e("filterManager")],C.prototype,"filterManager",void 0),R([e("sortController")],C.prototype,"sortController",void 0),R([e("selectionService")],C.prototype,"selectionService",void 0),R([e("rowRenderer")],C.prototype,"rowRenderer",void 0),R([e("rowNodeBlockLoader")],C.prototype,"rowNodeBlockLoader",void 0),R([t],C.prototype,"init",null),R([o],C.prototype,"destroyDatasource",null),C=R([d("rowModel")],C);const v={version:"30.0.0",moduleName:l.InfiniteRowModelModule,rowModel:"infinite",beans:[C]};export{v as InfiniteRowModelModule};