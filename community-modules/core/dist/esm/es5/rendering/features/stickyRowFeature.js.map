{"version":3,"sources":["../../../src/ts/rendering/features/stickyRowFeature.ts"],"names":[],"mappings":"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","file":"stickyRowFeature.js","sourcesContent":["import { RowNode } from \"../../entities/rowNode\";\nimport { BeanStub } from \"../../context/beanStub\";\nimport { RowCtrl } from \"../row/rowCtrl\";\nimport { RowCtrlMap, RowRenderer } from \"../rowRenderer\";\nimport { Autowired, PostConstruct } from \"../../context/context\";\nimport { IRowModel } from \"../../interfaces/iRowModel\";\nimport { GridBodyCtrl } from \"../../gridBodyComp/gridBodyCtrl\";\nimport { CtrlsService } from \"../../ctrlsService\";\nimport { last } from \"../../utils/array\";\n\nexport class StickyRowFeature extends BeanStub {\n\n    @Autowired(\"rowModel\") private rowModel: IRowModel;\n    @Autowired(\"rowRenderer\") private rowRenderer: RowRenderer;\n    @Autowired(\"ctrlsService\") private ctrlsService: CtrlsService;\n\n    private stickyRowCtrls: RowCtrl[] = [];\n    private gridBodyCtrl: GridBodyCtrl;\n    private containerHeight = 0;\n\n    constructor(\n        private readonly createRowCon: (rowNode: RowNode, animate: boolean, afterScroll: boolean) => RowCtrl,\n        private readonly destroyRowCtrls: (rowCtrlsMap: RowCtrlMap | null | undefined, animate: boolean) => void\n    ) {\n        super();\n    }\n\n    @PostConstruct\n    private postConstruct(): void {\n        this.ctrlsService.whenReady(params => {\n            this.gridBodyCtrl = params.gridBodyCtrl;\n        });\n    }\n\n    public getStickyRowCtrls(): RowCtrl[] {\n        return this.stickyRowCtrls;\n    }\n\n    public checkStickyRows(): void {\n        let height = 0;\n\n        if (!this.gridOptionsWrapper.isGroupRowsSticky()) {\n            this.refreshNodesAndContainerHeight([], height);\n            return;\n        }\n\n        const stickyRows: RowNode[] = [];\n        const firstPixel = this.rowRenderer.getFirstVisibleVerticalPixel();\n\n        const addStickyRow = (stickyRow: RowNode) => {\n            stickyRows.push(stickyRow);\n\n            let lastAncester = stickyRow;\n            while (lastAncester.expanded) {\n                lastAncester = last(lastAncester.childrenAfterSort!);\n            }\n            const lastChildBottom = lastAncester.rowTop! + lastAncester.rowHeight!;\n            const stickRowBottom = firstPixel + height + stickyRow.rowHeight!;\n            if (lastChildBottom < stickRowBottom) {\n                stickyRow.stickyRowTop = height + (lastChildBottom - stickRowBottom);\n            } else {\n                stickyRow.stickyRowTop = height;\n            }\n\n            height = 0;\n            stickyRows.forEach(rowNode => {\n                const thisRowLastPx = rowNode.stickyRowTop + rowNode.rowHeight!;\n                if (height < thisRowLastPx) {\n                    height = thisRowLastPx;\n                }\n            });\n\n        };\n\n        while (true) {\n            const firstPixelAfterStickyRows = firstPixel + height;\n            const firstIndex = this.rowModel.getRowIndexAtPixel(firstPixelAfterStickyRows);\n            const firstRow = this.rowModel.getRow(firstIndex);\n\n            if (firstRow == null) {  break; }\n\n            // only happens when pivoting, and we are showing root node\n            if (firstRow.level < 0) { break; }\n\n            const parents: RowNode[] = [];\n            let p = firstRow.parent!;\n            while (p.level >= 0) {\n                parents.push(p);\n                p = p.parent!;\n            }\n            const firstMissingParent = parents.reverse().find(parent => stickyRows.indexOf(parent) < 0);\n            if (firstMissingParent) {\n                addStickyRow(firstMissingParent);\n                continue;\n            }\n\n            // if first row is an open group, and practically shown, it needs\n            // to be stuck\n            if (firstRow.group && firstRow.expanded && !firstRow.footer && firstRow.rowTop! < firstPixelAfterStickyRows) {\n                addStickyRow(firstRow);\n                continue;\n            }\n\n            break;\n        }\n\n        this.refreshNodesAndContainerHeight(stickyRows, height);\n    }\n\n    private refreshNodesAndContainerHeight(allStickyNodes: RowNode[], height: number): void {\n        const removedCtrls = this.stickyRowCtrls.filter(ctrl => allStickyNodes.indexOf(ctrl.getRowNode()) === -1);\n        const addedNodes = allStickyNodes.filter(rowNode => this.stickyRowCtrls.findIndex(ctrl => ctrl.getRowNode() === rowNode) === -1);\n\n        const ctrlsToDestroy: RowCtrlMap = {};\n        removedCtrls.forEach(removedCtrl => {\n            ctrlsToDestroy[removedCtrl.getRowNode().id!] = removedCtrl;\n            this.stickyRowCtrls = this.stickyRowCtrls.filter(ctrl => ctrl !== removedCtrl);\n        });\n\n        for (const ctrl of Object.values(ctrlsToDestroy)) {\n            ctrl.getRowNode().sticky = false;\n        }\n\n        this.destroyRowCtrls(ctrlsToDestroy, false);\n\n        const newCtrls = addedNodes.map(rowNode => {\n            rowNode.sticky = true;\n            return this.createRowCon(rowNode, false, false);\n        });\n\n        this.stickyRowCtrls.push(...newCtrls);\n        this.stickyRowCtrls.forEach(ctrl => ctrl.setRowTop(ctrl.getRowNode().stickyRowTop));\n        this.stickyRowCtrls.sort((a, b) => b.getRowNode().rowIndex! - a.getRowNode().rowIndex!);\n\n        if (this.containerHeight !== height) {\n            this.containerHeight = height;\n            this.gridBodyCtrl.setStickyTopHeight(height);\n        }\n    }\n}"]}